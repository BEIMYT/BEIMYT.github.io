<!DOCTYPE html>
<html lang="en">
<head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PKVYPG2JS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-4PKVYPG2JS');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Community Chat ðŸ’¬</title>

<!-- Firebase & Main Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, remove, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDnoJBLK4l7gokAz7d78gtZSi5sT5a8lXQ",
  authDomain: "beim-notes.firebaseapp.com",
  projectId: "beim-notes",
  storageBucket: "beim-notes.firebasestorage.app",
  messagingSenderId: "861389311161",
  appId: "1:861389311161:web:8d47e467a276f6a1e09f68",
  measurementId: "G-4PKVYPG2JS",
  databaseURL: "https://beim-notes-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM Elements
const loginScreen = document.getElementById("loginScreen");
const chatScreen = document.getElementById("chatScreen");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const cooldownNotice = document.getElementById("cooldownNotice");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const toggleMode = document.getElementById("toggleMode");
const loginBtn = document.getElementById("loginBtn");
const title = document.getElementById("title");
const reminderMsg = document.getElementById("reminderMsg");
const logoutBtn = document.getElementById("logoutBtn");
const chatCeilingReminder = document.getElementById("chatCeilingReminder");

// ToS elements
let tosModal, tosOverlay, tosAcknowledgeBtn;

let isLoginMode = true;
let currentUser = null;
let cooldown = false;
let cooldownTimer = null;

// Always show ToS modal
function showTOSModal(thenShowChat) {
  tosOverlay.style.display = "flex";
  tosModal.style.display = "flex";
  tosAcknowledgeBtn.focus();
  tosAcknowledgeBtn.onclick = () => {
    tosOverlay.style.display = "none";
    tosModal.style.display = "none";
    if (thenShowChat) thenShowChat();
  };
}

// Toggle mode login/signup
toggleMode.addEventListener("click", () => {
  isLoginMode = !isLoginMode;
  title.textContent = isLoginMode ? "Login" : "Sign Up";
  loginBtn.textContent = isLoginMode ? "Login" : "Register";
  toggleMode.textContent = isLoginMode
    ? "Don't have an account? Sign up!"
    : "Already have an account? Login!";
});

// Hash password
function hashPassword(str) {
  return btoa(str.split("").reverse().join(""));
}

// Login/register handler
loginBtn.addEventListener("click", async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if (!username || !password) return alert("Please fill all fields!");

  const userRef = ref(db, "users/" + username);
  const snap = await get(userRef);

  if (isLoginMode) {
    if (!snap.exists()) return alert("User not found!");
    if (snap.val().password !== hashPassword(password)) return alert("Wrong password!");
    currentUser = username;
  } else {
    if (snap.exists()) return alert("Username already taken!");
    await set(userRef, { password: hashPassword(password) });
    currentUser = username;
  }

  localStorage.setItem("chatUser", username);
  showChat();
});

// Show chat
function showChat() {
  loginScreen.style.display = "none";
  chatScreen.style.display = "flex";
  listenForMessages();
}

// Auto-login gated behind ToS
window.addEventListener("load", () => {
  showTOSModal(function() {
    const savedUser = localStorage.getItem("chatUser");
    if (savedUser) {
      currentUser = savedUser;
      showChat();
    }
  });
});

// Load existing and live messages
function listenForMessages() {
  messagesDiv.innerHTML = "";
  const chatRef = query(ref(db, "chat"), orderByChild("timestamp"));

  get(chatRef).then(snapshot => {
    if (snapshot.exists()) {
      snapshot.forEach(childSnapshot => {
        const msg = childSnapshot.val();
        const now = Date.now();

        if (now - msg.timestamp <= 24 * 60 * 60 * 1000) {
          const div = document.createElement("div");
          div.classList.add("msg");
          div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
          messagesDiv.appendChild(div);
        } else {
          remove(ref(db, "chat/" + childSnapshot.key));
        }
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  });

  onChildAdded(chatRef, (snapshot) => {
    const msg = snapshot.val();
    const now = Date.now();
    if (now - msg.timestamp > 24 * 60 * 60 * 1000) {
      remove(ref(db, "chat/" + snapshot.key));
      return;
    }

    const div = document.createElement("div");
    div.classList.add("msg");
    div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// Cooldown
function startCooldown(seconds) {
  cooldown = true;
  sendBtn.disabled = true;
  let remaining = seconds;

  cooldownNotice.textContent = `Please wait ${remaining}s`;

  cooldownTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(cooldownTimer);
      cooldown = false;
      sendBtn.disabled = false;
      cooldownNotice.textContent = "";
    } else {
      cooldownNotice.textContent = `Please wait ${remaining}s`;
    }
  }, 1000);
}

// Send message
sendBtn.addEventListener("click", async () => {
  if (cooldown) return;

  const text = msgInput.value.trim();
  if (!text) return;
  if (text.length > 50) return alert("Max 50 chars!");

  await push(ref(db, "chat"), { user: currentUser, text, timestamp: Date.now() });

  msgInput.value = "";
  startCooldown(7);
});

// Enter to send
msgInput.addEventListener("keydown", (event) => {
  if (event.key === "Enter" && !sendBtn.disabled && !cooldown) {
    event.preventDefault();
    sendBtn.click();
  }
});

// Logout
logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("chatUser");
  currentUser = null;
  messagesDiv.innerHTML = "";
  chatScreen.style.display = "none";
  loginScreen.style.display = "flex";
});

// Inject TOS modal
(() => {
  tosOverlay = document.createElement("div");
  tosOverlay.id = "tosOverlay";
  tosOverlay.style = `
    display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;
    background:rgba(0,0,0,0.68);align-items:center;justify-content:center;
  `;

  tosModal = document.createElement("div");
  tosModal.style = `
    display:none;flex-direction:column;gap:22px;padding:35px 24px;background:#1f1c28;
    border-radius:16px;max-width:96vw;width:400px;align-items:center;border:2px solid orange;
  `;

  const tosTitle = document.createElement("h3");
  tosTitle.textContent = "Terms of Service for Posting";
  tosTitle.style = "color:orange;margin:0;text-align:center;";
  tosModal.appendChild(tosTitle);

  const tosContent = document.createElement("ul");
  tosContent.style = "color:#ffeccb;text-align:left;";
  tosContent.innerHTML = `
    <li><b>Consent to Ownership:</b> You grant the website owner (BEIM) the rights to use messages and credentials both outside & inside the website.</li>
    <li><b>No Editing or Deletion:</b> You understand that you cannon edit nor delete posted messages. While you may ask the website owner to delete a message he is not obligated to comply.</li>
    <li><b>Public Visibility:</b> Messages are visible publicly to anyone who visites the website and creates an acount or logs in. Also messages get auto-delete after 24h from both the website and the database.</li>`;
    <b>Last updated: 22/11/2025 11:57am UTC +2</b>
  tosModal.appendChild(tosContent);

  tosAcknowledgeBtn = document.createElement("button");
  tosAcknowledgeBtn.textContent = "I understand";
  tosModal.appendChild(tosAcknowledgeBtn);

  tosOverlay.appendChild(tosModal);
  document.body.appendChild(tosOverlay);
})();
</script>

<style>
body {
  background:#0e0e0e;color:#f2f2f2;font-family:Poppins,sans-serif;
  display:flex;align-items:center;justify-content:center;height:100vh;margin:0;
}

#loginScreen,#chatScreen {
  display:none;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:400px;
}

input {
  width:80%;padding:10px;border:none;border-radius:5px;outline:none;
}

button {
  padding:10px 15px;border:none;border-radius:5px;background:orange;color:#111;font-weight:bold;
}

#messages {
  background:#1a1a1a;width:90%;height:60vh;overflow-y:auto;padding:10px;border-radius:10px;
  display:flex;flex-direction:column;gap:5px;margin-bottom:10px;
}

.msg {
  background:#222;padding:8px 12px;border-radius:5px;word-wrap:break-word;text-align:left;
}

#cooldownNotice { color:orange;font-size:0.95em;min-height:20px;text-align:center; }
#reminderMsg { color:#ee2222;font-size:0.9em; }
</style>

</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" style="display:flex;">
  <h2 id="title">Login</h2>
  <input id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <div id="reminderMsg">remember to refresh page after signing in</div>
  <p id="toggleMode" style="cursor:pointer;color:orange;">Don't have an account? Sign up!</p>
</div>

<!-- Chat Screen -->
<div id="chatScreen">
  <div id="chatCeilingReminder">REMEMBER: Messages auto-delete after 24 hours</div>
  <button id="logoutBtn">Logout</button>
  <h2>Community Chat ðŸ’¬</h2>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Type a message..." maxlength="50" />
  <div id="cooldownNotice"></div>
  <button id="sendBtn">Send</button>
</div>

</body>
</html>


