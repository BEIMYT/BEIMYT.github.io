<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Chat ðŸ’¬</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, query, orderByChild, startAt } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // ðŸ”¥ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDnoJBLK4l7gokAz7d78gtZSi5sT5a8lXQ",
      authDomain: "beim-notes.firebaseapp.com",
      databaseURL: "https://beim-notes-default-rtdb.firebaseio.com/",
      projectId: "beim-notes",
      storageBucket: "beim-notes.firebasestorage.app",
      messagingSenderId: "861389311161",
      appId: "1:861389311161:web:8d47e467a276f6a1e09f68",
      measurementId: "G-4PKVYPG2JS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "community-messages");

    const loginDiv = document.getElementById("loginDiv");
    const chatDiv = document.getElementById("chatDiv");
    const messageList = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");

    let username = localStorage.getItem("username");
    let password = localStorage.getItem("password");
    let cooldown = false;

    // === LOGIN HANDLING ===
    if (username && password) {
      loginDiv.style.display = "none";
      chatDiv.style.display = "block";
    }

    loginBtn.addEventListener("click", () => {
      const user = usernameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (user.length < 3 || pass.length < 3) {
        alert("Username and password must be at least 3 characters long!");
        return;
      }
      localStorage.setItem("username", user);
      localStorage.setItem("password", pass);
      location.reload();
    });

    // === LOGOUT ===
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("username");
      localStorage.removeItem("password");
      location.reload();
    });

    // === SEND MESSAGE ===
    sendBtn.addEventListener("click", async () => {
      if (cooldown) return alert("Wait a few seconds before sending another message!");

      const text = messageInput.value.trim();
      if (text === "" || text.length > 50) return;

      const now = new Date();
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      const time = `${hours}:${minutes}`;

      await push(messagesRef, {
        username: username,
        text: text,
        time: time,
        timestamp: now.getTime()
      });

      messageInput.value = "";
      cooldown = true;
      sendBtn.disabled = true;
      setTimeout(() => {
        cooldown = false;
        sendBtn.disabled = false;
      }, 7000); // 7s cooldown
    });

    // === DISPLAY MESSAGES ===
    const msgQuery = query(messagesRef, orderByChild("timestamp"), startAt(Date.now() - 24 * 60 * 60 * 1000)); // show last 24h only

    onChildAdded(msgQuery, (data) => {
      const msg = data.val();
      const li = document.createElement("li");
      li.innerHTML = `<strong>${msg.username}</strong> <span style="color:gray;font-size:0.8em;">${msg.time}</span><br>${msg.text}`;
      messageList.appendChild(li);
      messageList.scrollTop = messageList.scrollHeight;
    });

  </script>

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: "Poppins", sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #loginDiv, #chatDiv {
      display: none;
      padding: 40px;
    }
    input {
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin: 5px;
      width: 200px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background: orange;
      color: black;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      background: gold;
      transform: scale(1.05);
    }
    ul {
      list-style: none;
      max-height: 400px;
      overflow-y: auto;
      padding: 0;
      margin: 20px auto;
      background: #222;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
      text-align: left;
    }
    li {
      padding: 8px 12px;
      border-bottom: 1px solid #333;
      word-wrap: break-word;
    }
    #logoutBtn {
      position: fixed;
      top: 15px;
      right: 15px;
      background: crimson;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    #logoutBtn:hover {
      background: #ff4d4d;
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(255,0,0,0.6);
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="loginDiv" style="display: block;">
    <h1>Community Login</h1>
    <input id="username" type="text" placeholder="Username"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button id="loginBtn">Enter Chat</button>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatDiv" style="display: none;">
    <h1>Live Community Chat ðŸ’¬</h1>
    <ul id="messages"></ul>
    <input type="text" id="messageInput" placeholder="Type your message..." maxlength="50">
    <button id="sendBtn">Send</button>
  </div>

  <!-- LOGOUT BUTTON -->
  <button id="logoutBtn">Logout</button>

</body>
</html>
