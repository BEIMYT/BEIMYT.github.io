<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community Chat</title>
  <style>
    html,body{height:100%;margin:0;font-family:sans-serif;background:#203a43;color:#eee;}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;}
    .card{width:100%;max-width:750px;background:rgba(255,255,255,0.04);border-radius:12px;padding:18px;}
    #messages{background:rgba(0,0,0,0.09);border-radius:10px;padding:12px;height:300px;overflow-y:auto;margin:12px 0;}
    .msg{margin-bottom:6px;padding:8px 12px;background:rgba(255,255,255,0.09);border-radius:8px;}
    .meta{font-size:.92em;color:#90caf9;}
    #online{margin-bottom:6px;font-size:.92em;color:#9aa6b2;}
    .composer{display:flex;gap:8px;}
    .composer input{flex:1;padding:9px;border-radius:7px;border:none;}
    .composer button{padding:9px 14px;border:none;border-radius:7px;background:orange;font-weight:700;}
    #authNotice{margin-left:9px;color:#ffb86b;}
    .toggleModeBtn{background:none;border:none;color:orange;text-decoration:underline;cursor:pointer;margin-top:5px;font-size:1em;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Community Chat ðŸ’¬</h1>
    <div id="online"></div>
    <div id="login" style="display:block">
      <h2 id="loginModeTitle">Login</h2>
      <input id="user" placeholder="Username" maxlength="20">
      <input id="pass" type="password" placeholder="Password">
      <div>
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign up</button>
        <span id="authNotice"></span>
      </div>
      <button class="toggleModeBtn" id="toggleModeBtn">Switch to Sign up</button>
    </div>
    <div id="chat" style="display:none">
      <div id="messages"></div>
      <div class="composer">
        <input id="msgInput" maxlength="50" placeholder="Write a message...">
        <button id="sendBtn">Send</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>
</div>
<script type="module">
const {initializeApp} = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
const {getDatabase,ref,push,onChildAdded,onValue,set,get,remove,query,orderByChild} = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js');
const config = {
  apiKey: "AIzaSyDnoJBLK4l7gokAz7d78gtZSi5sT5a8lXQ",
  authDomain: "beim-notes.firebaseapp.com",
  databaseURL: "https://beim-notes-default-rtdb.firebaseio.com",
  projectId: "beim-notes",
  storageBucket: "beim-notes.appspot.com",
  messagingSenderId: "861389311161",
  appId: "1:861389311161:web:8d47e467a276f6a1e09f68"
};
const app = initializeApp(config);
const db = getDatabase(app);

const userEl = document.getElementById('user'), passEl = document.getElementById('pass');
const loginDiv = document.getElementById('login'), chatDiv = document.getElementById('chat');
const loginBtn = document.getElementById('loginBtn'), signupBtn = document.getElementById('signupBtn');
const authNotice = document.getElementById('authNotice');
const msgInput = document.getElementById('msgInput'), sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const onlineDiv = document.getElementById('online');
const logoutBtn = document.getElementById('logoutBtn');
const loginModeTitle = document.getElementById('loginModeTitle');
const toggleModeBtn = document.getElementById('toggleModeBtn');

function hash(s){ return btoa(s.split('').reverse().join('')); }
let myUser = localStorage.getItem('chatUser') || null;
let cooldown = false;

let loginMode = true; // true for Login, false for Sign Up

function updateLoginUI() {
  if (loginMode) {
    loginModeTitle.textContent = "Login";
    loginBtn.style.display = 'inline-block';
    signupBtn.style.display = 'none';
    toggleModeBtn.textContent = "Switch to Sign up";
  } else {
    loginModeTitle.textContent = "Sign Up";
    loginBtn.style.display = 'none';
    signupBtn.style.display = 'inline-block';
    toggleModeBtn.textContent = "Switch to Login";
  }
  authNotice.textContent = '';
}
toggleModeBtn.onclick = function() {
  loginMode = !loginMode;
  updateLoginUI();
};

async function updateOnline() {
  onValue(ref(db, 'presence'), snap => {
    const data = snap.val() || {};
    const list = Object.keys(data);
    onlineDiv.textContent = list.length ? 'Online: ' + list.join(', ') : 'No one online';
  });
}
function showChatUI() {
  loginDiv.style.display = 'none';
  chatDiv.style.display = 'block';
  msgInput.focus();
  set(ref(db,'presence/'+myUser),{ts:Date.now()});
  updateOnline();
}
function logout() {
  remove(ref(db,'presence/'+myUser));
  localStorage.removeItem('chatUser');
  location.reload();
}
async function auth(doLogin) {
  let u = userEl.value.trim(), p = passEl.value.trim();
  if(u.length<3||u.length>20) { authNotice.textContent='Username=3â€“20 chars';return; }
  if(p.length<3) { authNotice.textContent='Password too short';return; }
  authNotice.textContent = '...';
  const userRef = ref(db, 'users/'+u), snap = await get(userRef);
  if(doLogin) {
    if(!snap.exists()) { authNotice.textContent = 'User not found'; return; }
    if(snap.val().password !== hash(p)) { authNotice.textContent='Wrong password'; return;}
    myUser=u; localStorage.setItem('chatUser',u);
    showChatUI();
  } else {
    if(snap.exists()) { authNotice.textContent = 'User taken'; return; }
    await set(userRef, {password:hash(p)});
    myUser=u; localStorage.setItem('chatUser',u);
    showChatUI();
  }
}
loginBtn.onclick = ()=>auth(true);
signupBtn.onclick = ()=>auth(false);
logoutBtn.onclick = logout;

function renderMsg(msgObj) {
  let d = document.createElement('div');
  d.className='msg';
  d.innerHTML =
    '<div class="meta">'+(msgObj.user||'anon')+' @ '+(msgObj.time||'')+'</div>' +
    '<div>' + (msgObj.text||'') + '</div>';
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage() {
  if(!myUser||cooldown) return;
  let text = (msgInput.value||'').trim();
  if(!text) return;
  if(text.length>50) return;
  let now = new Date();
  let hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
  await push(ref(db,'chat'),{user:myUser,text:text,time:`${hh}:${mm}`,timestamp:now.getTime()});
  msgInput.value='';
  cooldown = true; sendBtn.disabled=true;
  setTimeout(()=>{cooldown=false;sendBtn.disabled=false;}, 7000);
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});

function liveMessages() {
  const q = query(ref(db,'chat'),orderByChild('timestamp'));
  onChildAdded(q, async snap=>{
    let obj = snap.val(), key=snap.key;
    if(!obj) return;
    let age=Date.now()-(obj.timestamp||0);
    if(age>24*60*60*1000) { await remove(ref(db,'chat/'+key)); return;}
    renderMsg(obj);
  });
}

if(myUser) {
  showChatUI(); liveMessages();
} else {
  chatDiv.style.display='none';
  updateLoginUI(); // set correct initial login/signup view
}

loginDiv.style.display=myUser?'none':'block';
chatDiv.style.display=myUser?'block':'none';
liveMessages(); // so messages show to those not logged in, too

</script>
</body>
</html>
