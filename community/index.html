<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PKVYPG2JS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-4PKVYPG2JS');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Community Chat ðŸ’¬</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, remove, query, orderByChild, onDisconnect, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDnoJBLK4l7gokAz7d78gtZSi5sT5a8lXQ",
  authDomain: "beim-notes.firebaseapp.com",
  projectId: "beim-notes",
  storageBucket: "beim-notes.firebasestorage.app",
  messagingSenderId: "861389311161",
  appId: "1:861389311161:web:8d47e467a276f6a1e09f68",
  measurementId: "G-4PKVYPG2JS",
  databaseURL: "https://beim-notes-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM Elements
const loginScreen = document.getElementById("loginScreen");
const chatScreen = document.getElementById("chatScreen");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const cooldownNotice = document.getElementById("cooldownNotice");
const onlineUsersDiv = document.getElementById("onlineUsers");

const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const toggleMode = document.getElementById("toggleMode");
const title = document.getElementById("title");
const loginBtn = document.getElementById("loginBtn");

const reminderMsg = document.getElementById("reminderMsg");
const logoutBtn = document.getElementById("logoutBtn");

let isLoginMode = true;
let currentUser = null;
let cooldown = false;
let cooldownTimer = null;

// Random color generator
function getRandomColor() {
  const colors = ["#F6BD60","#84A59D","#F28482","#F7EDE2","#FFB200","#FF6F61","#8AB9B5","#ECA3F5","#9BE564","#7BDFF2"];
  return colors[Math.floor(Math.random() * colors.length)];
}

// Hash password
function hashPassword(str) {
  return btoa(str.split("").reverse().join(""));
}

// Toggle signup/login
toggleMode.addEventListener("click", () => {
  isLoginMode = !isLoginMode;
  title.textContent = isLoginMode ? "Login" : "Sign Up";
  loginBtn.textContent = isLoginMode ? "Login" : "Register";
  toggleMode.textContent = isLoginMode
    ? "Don't have an account? Sign up!"
    : "Already have an account? Login!";
});

// Login / Register
loginBtn.addEventListener("click", async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if (!username || !password) return alert("Fill all fields");

  const userRef = ref(db, "users/" + username);
  const snap = await get(userRef);

  if (isLoginMode) {
    if (!snap.exists()) return alert("User not found");
    if (snap.val().password !== hashPassword(password)) return alert("Wrong password");
    currentUser = username;
  } else {
    if (snap.exists()) return alert("Username taken!");
    await set(userRef, { password: hashPassword(password), color: getRandomColor() });
    currentUser = username;
  }

  localStorage.setItem("chatUser", currentUser);
  showChat();
});

// Show chat function
function showChat() {
  loginScreen.style.display = "none";
  chatScreen.style.display = "flex";
  setupPresence();
  listenForOnlineUsers();
  loadUserColor();
  listenForMessages();
}

// Load user color
async function loadUserColor() {
  const snap = await get(ref(db, "users/" + currentUser));
  currentColor = snap.val().color;
}

// Presence system
function setupPresence() {
  const statusRef = ref(db, "presence/" + currentUser);
  set(statusRef, true);
  onDisconnect(statusRef).remove();
}

function listenForOnlineUsers() {
  const usersRef = ref(db, "presence");
  onChildAdded(usersRef, () => updateOnlineUsers());
  onChildRemoved(usersRef, () => updateOnlineUsers());
}

async function updateOnlineUsers() {
  const usersRef = ref(db, "presence");
  const snapshot = await get(usersRef);

  let list = [];
  for (const userKey in snapshot.val()) {
    list.push(userKey);
  }

  let html = `Online (${list.length}): `;
  for (let u of list) {
    const userSnap = await get(ref(db, "users/" + u));
    const color = userSnap.exists() ? userSnap.val().color : "white";
    html += `<span style="color:${color};font-weight:bold;">${u}</span> `;
  }

  onlineUsersDiv.innerHTML = html;
}

// Listen for messages
function listenForMessages() {
  messagesDiv.innerHTML = "";
  const chatRef = query(ref(db, "chat"), orderByChild("timestamp"));
  get(chatRef).then(snapshot => {
    if (snapshot.exists()) {
      snapshot.forEach(childSnapshot => displayMessage(childSnapshot));
    }
  });

  onChildAdded(chatRef, (snapshot) => displayMessage(snapshot));
}

async function displayMessage(snapshot) {
  const msg = snapshot.val();
  const now = Date.now();
  if (now - msg.timestamp > 24*60*60*1000) return remove(ref(db,"chat/"+snapshot.key));

  const snap = await get(ref(db,"users/"+msg.user));
  const color = snap.exists() ? snap.val().color : "white";

  const div = document.createElement("div");
  div.classList.add("msg");
  div.innerHTML = `<b style="color:${color}">${msg.user}</b>: ${msg.text}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Send message
sendBtn.addEventListener("click", async () => {
  if (cooldown) return;
  const text = msgInput.value.trim();
  if (!text) return;
  if (text.length > 50) return alert("Max 50 chars");

  await push(ref(db, "chat"), { user: currentUser, text, timestamp: Date.now() });
  msgInput.value = "";
  startCooldown(7);
});

// Enter â†’ send
msgInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !cooldown) sendBtn.click();
});

// Cooldown
function startCooldown(seconds) {
  cooldown = true;
  sendBtn.disabled = true;
  let remaining = seconds;
  cooldownNotice.textContent = `Wait ${remaining}s`;
  cooldownTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(cooldownTimer);
      cooldownNotice.textContent = "";
      cooldown = false;
      sendBtn.disabled = false;
    } else cooldownNotice.textContent = `Wait ${remaining}s`;
  }, 1000);
}

// Logout
logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("chatUser");
  currentUser = null;
  chatScreen.style.display = "none";
  loginScreen.style.display = "flex";
});

// Auto-login
window.addEventListener("load", () => {
  const savedUser = localStorage.getItem("chatUser");
  if (savedUser) {
    currentUser = savedUser;
    showChat();
  }
});
</script>

<style>
body { background:#0e0e0e;color:#f2f2f2;font-family:Poppins,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;}
#loginScreen,#chatScreen {display:none;flex-direction:column;align-items:center;gap:10px;max-width:400px;width:100%;}
input {padding:10px;width:80%;border-radius:5px;border:none;outline:none;}
button{padding:10px 15px;border:none;border-radius:5px;background:orange;color:#111;font-weight:bold;cursor:pointer;}

#messages {background:#1a1a1a;width:90%;height:60vh;overflow-y:auto;padding:10px;border-radius:10px;margin-bottom:10px;display:flex;flex-direction:column;gap:5px;}
.msg {background:#222;padding:8px 12px;border-radius:5px;word-wrap:break-word;text-align:left;}

#onlineUsers {background:#131313;border-radius:10px;padding:8px;width:90%;margin-bottom:8px;color:orange;font-weight:600;text-align:left;}
</style>

</head>
<body>

<div id="loginScreen" style="display:flex;">
  <h2 id="title">Login</h2>
  <input id="username" placeholder="Username"/>
  <input id="password" type="password" placeholder="Password"/>
  <button id="loginBtn">Login</button>
  <div id="reminderMsg" style="color:#ee2222;font-size:.85em;margin-top:4px;">refresh after sign up</div>
  <p id="toggleMode" style="cursor:pointer;color:orange;">Don't have an account? Sign up!</p>
</div>

<div id="chatScreen">
  <button id="logoutBtn">Logout</button>
  <h2>Community Chat ðŸ’¬</h2>
  <div id="onlineUsers">Online: Loading...</div>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Type a message..." maxlength="50"/>
  <div id="cooldownNotice"></div>
  <button id="sendBtn">Send</button>
</div>

</body>
</html>
