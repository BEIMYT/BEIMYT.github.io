<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Chat ðŸ’¬</title>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, get, remove, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // Firebase config (same project)
    const firebaseConfig = {
      apiKey: "AIzaSyDnoJBLK4l7gokAz7d78gtZSi5sT5a8lXQ",
      authDomain: "beim-notes.firebaseapp.com",
      projectId: "beim-notes",
      storageBucket: "beim-notes.firebasestorage.app",
      messagingSenderId: "861389311161",
      appId: "1:861389311161:web:8d47e467a276f6a1e09f68",
      measurementId: "G-4PKVYPG2JS",
      databaseURL: "https://beim-notes-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const loginScreen = document.getElementById("loginScreen");
    const chatScreen = document.getElementById("chatScreen");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const cooldownNotice = document.getElementById("cooldownNotice");

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const toggleMode = document.getElementById("toggleMode");
    const loginBtn = document.getElementById("loginBtn");
    const title = document.getElementById("title");

    const logoutBtn = document.getElementById("logoutBtn");

    // ToS Modal elements (added later via HTML)
    let tosModal, tosOverlay, tosAcknowledgeBtn;

    let isLoginMode = true;
    let currentUser = null;
    let cooldown = false;
    let cooldownTimer = null;

    // Toggle login/register
    toggleMode.addEventListener("click", () => {
      isLoginMode = !isLoginMode;
      title.textContent = isLoginMode ? "Login" : "Sign Up";
      loginBtn.textContent = isLoginMode ? "Login" : "Register";
      toggleMode.textContent = isLoginMode
        ? "Don't have an account? Sign up!"
        : "Already have an account? Login!";
    });

    // Hash passwords (simple client-side)
    function hashPassword(str) {
      return btoa(str.split("").reverse().join(""));
    }

    // Terms of Service Modal Logic
    function showTOSModalIfNeeded(thenShowChat) {
      if (localStorage.getItem("chatTOSAccepted") === "true") {
        thenShowChat();
        return;
      }
      tosOverlay.style.display = "flex";
      tosModal.style.display = "flex";
      tosAcknowledgeBtn.focus();
      tosAcknowledgeBtn.onclick = () => {
        tosOverlay.style.display = "none";
        tosModal.style.display = "none";
        localStorage.setItem("chatTOSAccepted", "true");
        thenShowChat();
      };
    }

    // Register / Login
    loginBtn.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!username || !password) return alert("Please fill all fields!");

      const userRef = ref(db, "users/" + username);
      const snap = await get(userRef);

      if (isLoginMode) {
        // Login
        if (!snap.exists()) return alert("User not found!");
        if (snap.val().password !== hashPassword(password))
          return alert("Wrong password!");
        currentUser = username;
        localStorage.setItem("chatUser", username);
        showTOSModalIfNeeded(showChat);
      } else {
        // Register
        if (snap.exists()) return alert("Username already taken!");
        await set(userRef, { password: hashPassword(password) });
        currentUser = username;
        localStorage.setItem("chatUser", username);
        showTOSModalIfNeeded(showChat);
      }
    });

    // Show chat screen
    function showChat() {
      loginScreen.style.display = "none";
      chatScreen.style.display = "flex";
      listenForMessages();
    }

    // Auto-login
    window.addEventListener("load", () => {
      const savedUser = localStorage.getItem("chatUser");
      if (savedUser) {
        currentUser = savedUser;
        showTOSModalIfNeeded(showChat);
      }
    });

    // Listen for messages (real-time and persistent)
    function listenForMessages() {
      messagesDiv.innerHTML = ""; // always clear before repopulating
      const chatRef = query(ref(db, "chat"), orderByChild("timestamp"));
      // First: load all existing messages
      get(chatRef).then(snapshot => {
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const msg = childSnapshot.val();
            // Only display non-expired messages
            const now = Date.now();
            if (now - msg.timestamp <= 24 * 60 * 60 * 1000) {
              const div = document.createElement("div");
              div.classList.add("msg");
              div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
              messagesDiv.appendChild(div);
            } else {
              // Remove expired messages
              remove(ref(db, "chat/" + childSnapshot.key));
            }
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      });

      // Second: subscribe for incremental new messages
      onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        const now = Date.now();
        if (now - msg.timestamp > 24 * 60 * 60 * 1000) {
          remove(ref(db, "chat/" + snapshot.key));
          return;
        }
        const div = document.createElement("div");
        div.classList.add("msg");
        div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // Cooldown handling
    function startCooldown(seconds) {
      cooldown = true;
      sendBtn.disabled = true;
      let remaining = seconds;
      cooldownNotice.textContent = `Please wait ${remaining}s before sending another message.`;
      cooldownTimer = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(cooldownTimer);
          cooldown = false;
          sendBtn.disabled = false;
          cooldownNotice.textContent = '';
        } else {
          cooldownNotice.textContent = `Please wait ${remaining}s before sending another message.`;
        }
      }, 1000);
    }

    // Send message (with cooldown + length limit)
    sendBtn.addEventListener("click", async () => {
      if (cooldown) return;
      const text = msgInput.value.trim();
      if (!text) return;
      if (text.length > 50) return alert("Max 50 characters!");
      await push(ref(db, "chat"), {
        user: currentUser,
        text: text,
        timestamp: Date.now()
      });
      msgInput.value = ""; // Clear input
      startCooldown(7);
    });

    // Send message when Enter is pressed in msgInput (but only if not on cooldown)
    msgInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !sendBtn.disabled && !cooldown) {
        event.preventDefault();
        sendBtn.click();
      }
    });

    // Logout functionality
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("chatUser");
      currentUser = null;
      // Optionally clear chat UI
      messagesDiv.innerHTML = "";
      // Hide chat, show login
      chatScreen.style.display = "none";
      loginScreen.style.display = "flex";
      usernameInput.value = "";
      passwordInput.value = "";
      if (cooldownTimer) clearInterval(cooldownTimer);
      sendBtn.disabled = false;
      cooldownNotice.textContent = '';
      cooldown = false;
    });

    // ToS Modal DOM injection (runs immediately)
    (() => {
      // Create the modal overlay and modal
      tosOverlay = document.createElement("div");
      tosOverlay.id = "tosOverlay";
      tosOverlay.style = "display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.68);align-items:center;justify-content:center;";
      
      tosModal = document.createElement("div");
      tosModal.id = "tosModal";
      tosModal.style = "display:none;flex-direction:column;gap:22px;padding:35px 24px 28px 24px;background:linear-gradient(100deg,#1f1c28 80%,#23282f 100%);border-radius:16px;box-shadow:0 10px 40px #000a;border:2px solid orange;max-width:96vw;width:400px;align-items:center;";
      
      // Modal title
      const tosTitle = document.createElement("h3");
      tosTitle.textContent = "Terms of Service for Posting";
      tosTitle.style = "margin:0 0 10px 0;font-size:1.24em;font-weight:600;color:orange;text-align:center;";
      tosModal.appendChild(tosTitle);
      
      // Modal content (ToS)
      const tosContent = document.createElement("ul");
      tosContent.style = "color:#ffeccb;font-size:1.02em;line-height:1.5;text-align:left;margin:0 0 8px 0;padding-left:15px;";
      tosContent.innerHTML = `
        <li><b>Consent to Ownership:</b> You grant the website owner <b>(BEIM)</b> the right to use your messages in any manner, both within and outside the website.</li>
        <li><b>No Editing or Deletion:</b> You acknowledge that you cannot edit nor delete your posted messages. While you may request the owner to delete a message, the owner is not obligated to comply.</li>
        <li><b>Public Visibility:</b> You understand that every message you post will be visible to anyone who visits the website, including the owner (BEIM). Also keep in mind that every message stays up for 24h. After that they get deleted.</li>
      `;
      tosModal.appendChild(tosContent);
      
      // "I understand" button
      tosAcknowledgeBtn = document.createElement("button");
      tosAcknowledgeBtn.textContent = "I understand";
      tosAcknowledgeBtn.style = "padding:11px 30px;background:orange;color:#19162a;font-weight:700;border-radius:7px;text-shadow:0 1px 2px #fff7;box-shadow:0 1px 7px #19162a57;font-size:1.05em;border:none;cursor:pointer;margin-top:8px;";
      tosAcknowledgeBtn.tabIndex = 0;
      tosAcknowledgeBtn.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") tosAcknowledgeBtn.click();
      });
      tosModal.appendChild(tosAcknowledgeBtn);

      tosOverlay.appendChild(tosModal);
      document.body.appendChild(tosOverlay);
    })();
  </script>

  <style>
    body {
      background: #0e0e0e;
      color: #f2f2f2;
      font-family: "Poppins", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    #loginScreen, #chatScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      max-width: 400px;
    }
    input {
      padding: 10px;
      width: 80%;
      border-radius: 5px;
      border: none;
      outline: none;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background: orange;
      color: #111;
      cursor: pointer;
      font-weight: bold;
    }
    #messages {
      background: #1a1a1a;
      width: 90%;
      height: 60vh;
      overflow-y: auto;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .msg {
      background: #222;
      padding: 8px 12px;
      border-radius: 5px;
      word-wrap: break-word;
      text-align: left;
    }
    #chatScreen {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    /* Cooldown Notice Styling */
    #cooldownNotice {
      color: orange;
      min-height: 20px;
      font-size: 0.95em;
      margin-bottom: 4px;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.02em;
    }
    /* Logout Button Styling */
    #logoutBtn {
      align-self: flex-end;
      margin-bottom: 10px;
      margin-right: 10px;
      background: linear-gradient(90deg, #ff9800 40%, #ec4899 100%);
      color: white;
      border: none;
      padding: 8px 22px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 2px 10px #9a4e001f;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      position: relative;
      top: 0;
    }
    #logoutBtn:hover {
      background: linear-gradient(90deg, #ec4899 40%, #ff9800 100%);
      transform: translateY(-2px) scale(1.03);
    }
    /* ToS Modal Styling */
    #tosOverlay {
      /* style is set inline for critical modal, but can be extended here */
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" style="display: flex;">
    <h2 id="title">Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <p id="toggleMode" style="cursor: pointer; color: orange;">
      Don't have an account? Sign up!
    </p>
  </div>

  <!-- Chat Screen -->
  <div id="chatScreen">
    <button id="logoutBtn">Logout</button>
    <h2>Community Chat ðŸ’¬</h2>
    <div id="messages"></div>
    <input id="msgInput" placeholder="Type a message..." maxlength="50" />
    <div id="cooldownNotice"></div>
    <button id="sendBtn">Send</button>
  </div>
  <!-- ToS Modal is injected via JS -->
</body>
</html>
